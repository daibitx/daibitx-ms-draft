using Daibitx.DynamicApi.Runtime.Models;
using System.Text;

namespace Daibitx.DynamicApi.Runtime.Templates
{
    /// <summary>
    /// Controller Generater Template
    /// </summary>
    public class ControllerTemplate
    {
        public string Generate(
            string namespaceName,
            string controllerName,
            string interfaceName,
            string routePrefix,
            ApiExplorerSettings apiExplorerSettings,
            List<MethodInfo> methods)
        {
            var serviceName = interfaceName.ToLower();
            var sb = new StringBuilder();

            sb.AppendLine("// <auto-generated/>");
            sb.AppendLine("#pragma warning disable");
            sb.AppendLine("using System;");
            sb.AppendLine("using System.Threading.Tasks;");
            sb.AppendLine("using Microsoft.AspNetCore.Mvc;");
            sb.AppendLine("using Microsoft.AspNetCore.Http;");
            sb.AppendLine("using System.Collections.Generic;");
            sb.AppendLine();

            sb.AppendLine($"namespace {namespaceName}");
            sb.AppendLine("{");

            sb.AppendLine($"    [ApiController]");

            if (!string.IsNullOrEmpty(apiExplorerSettings.GroupName) || apiExplorerSettings.IgnoreApi)
            {
                var props = new List<string>();

                if (apiExplorerSettings.IgnoreApi)
                    props.Add("IgnoreApi = true");

                if (!string.IsNullOrEmpty(apiExplorerSettings.GroupName))
                    props.Add($"GroupName = \"{apiExplorerSettings.GroupName}\"");

                if (props.Any())
                    sb.AppendLine($"    [ApiExplorerSettings({string.Join(", ", props)})]");
            }


            sb.AppendLine($"    [Route(\"{routePrefix}\")]");

            sb.AppendLine($"    public class {controllerName} : ControllerBase");
            sb.AppendLine("    {");

            sb.AppendLine($"        private readonly {interfaceName} {serviceName};");
            sb.AppendLine();

            sb.AppendLine($"        public {controllerName}({interfaceName} service)");
            sb.AppendLine("        {");
            sb.AppendLine($"           {serviceName} = service ?? throw new ArgumentNullException(nameof(service));");
            sb.AppendLine("        }");
            sb.AppendLine();

            foreach (var method in methods)
            {
                GenerateMethod(sb, method, serviceName);
            }

            sb.AppendLine("    }");

            sb.AppendLine("}");
            sb.AppendLine();
            sb.AppendLine("#pragma warning restore");

            return sb.ToString();
        }
        private void GenerateMethod(StringBuilder sb, MethodInfo method, string serviceName)
        {
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// {method.Name} 方法");
            sb.AppendLine("        /// </summary>");

            sb.AppendLine($"        [{method.HttpMethod}]");

            var routeTemplate = GenerateRouteTemplate(method);
            if (!string.IsNullOrEmpty(routeTemplate))
            {
                sb.AppendLine($"        [Route(\"{routeTemplate}\")]");
            }
            var isAsync = IsAsyncReturnType(method.ReturnType);
            sb.Append($"       public {(!isAsync ? "" : "async ")} {method.ReturnType} {method.Name}(");

            var parameters = new List<string>();
            foreach (var param in method.Parameters)
            {
                var paramStr = new StringBuilder();

                if (!string.IsNullOrEmpty(param.BindingSource))
                {
                    paramStr.Append($"{param.BindingSource} ");
                }

                paramStr.Append($"{param.Type} {param.Name}");

                if (param.IsOptional)
                {
                    paramStr.Append($" = {param.DefaultValue}");
                }

                parameters.Add(paramStr.ToString());
            }

            sb.Append(string.Join(", ", parameters));
            sb.AppendLine(")");

            sb.AppendLine("        {");

            var args = string.Join(", ", method.Parameters.Select(p => p.Name));
           
            var isVoidTask = IsVoidTaskReturnType(method.ReturnType);
            if (isVoidTask)
            {
                sb.AppendLine($"            await {serviceName}.{method.Name}({args});");
            }
            else
            {
                sb.AppendLine($"            return await {serviceName}.{method.Name}({args});");
            }

            sb.AppendLine("        }");
            sb.AppendLine();
        }

        private bool IsAsyncReturnType(string returnType)
        {
            if (string.IsNullOrWhiteSpace(returnType))
                return false;

            var normalized = returnType.Trim();

            if (normalized.StartsWith("global::"))
                normalized = normalized.Substring("global::".Length);

            normalized = normalized.Replace(" ", "");

            var lower = normalized.ToLowerInvariant();

            if (lower == "system.threading.tasks.task")
                return true;

            if (lower.StartsWith("system.threading.tasks.task<"))
                return true;

            if (lower == "system.threading.tasks.valuetask")
                return true;

            if (lower.StartsWith("system.threading.tasks.valuetask<"))
                return true;

            if (lower == "task" || lower.StartsWith("task<"))
                return true;

            if (lower == "valuetask" || lower.StartsWith("valuetask<"))
                return true;

            return false;
        }

        private bool IsVoidTaskReturnType(string returnType)
        {
            if (string.IsNullOrWhiteSpace(returnType))
                return false;

            var normalized = returnType.Trim();

            if (normalized.StartsWith("global::"))
                normalized = normalized.Substring("global::".Length);

            normalized = normalized.Replace(" ", "");

            var lower = normalized.ToLowerInvariant();

            if (lower == "system.threading.tasks.task")
                return true;

            if (lower == "system.threading.tasks.valuetask")
                return true;

            if (lower == "task")
                return true;

            if (lower == "valuetask")
                return true;

            return false;
        }


        private string GenerateRouteTemplate(MethodInfo method)
        {
            var idParam = method.Parameters.FirstOrDefault(p => p.Name.ToLowerInvariant() is "id" or "key" or "code");

            if (idParam != null && method.HttpMethod == "HttpGet")
            {
                return "{id}";
            }

            return string.Empty;
        }
    }
}